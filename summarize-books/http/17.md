# 17. 내용 협상과 트랜스코딩

HTTP는 내용 협상\(content-negotiation\)을 이용해서 하나의 URL이 여러 가지 리소스 중 적합한 것에 대응되도록 할 수 있다. 또한 서버는 특정 URL에 대해 어떤 콘텐츠가 클라이언트에게 보내주기 가장 적절한지에 대한 다른 판단도 할 수 있어야 한다. 트랜스코딩은 HTTP 클라이언트와 서버 사이의 내용 협상에 대한 응답에서 수행된다.

## 내용 협상 기법

서버에 있는 페이지들 중 어떤 것이 클라이언트에게 맞는지 판단하는 세 가지 다른 방법이 있다.

{% tabs %}
{% tab title="클라이언트 주도" %}
1. 어떻게 동작하는가
   * 클라이언트가 요청을 보내면, 서버는 클라이언트에게 선택지를 보내주고, 클라이언트가 선택한다.
2. 장점
   * 서버 입장에서 가장 구현하기 쉽다. 클라이언트는 최선의 선택을 할 수 있다.
3. 단점
   * 대기시간이 증가한다. 즉, 올바른 콘텐츠를 얻으려면 최소 두번의 요청이 필요하다.
{% endtab %}

{% tab title="서버 주도" %}
1. 어떻게 동작하는가
   * 서버가 클라이언트의 요청 헤더를 검증해서 어떤 버전을 제공할지 결정한다.
2. 장점
   * 클라이언트 주도 협상보다 빠르다. HTTP는 서버가 가장 적절한 것을 선택할 수 있도록 q값 메커니즘을 제공하고, 서버가 다운스트림 장치에게 요청이 어떻게 평가되는지 말해줄수 있도록 하기 위해 Vary 헤더를 제공한다.
3. 단점
   * 만약 결정이 뻔하지 않으면\(헤더에 맞는 것이 없으면\), 서버는 추축을 해야 한다.
{% endtab %}

{% tab title="투명" %}
1. 어떻게 동작하는가
   * 투명한 중간 장치\(주로 프락시 캐시\)가 서버를 대신하여 협상을 한다.
2. 장점
   * 웹 서버가 협상을 할 필요가 없다. 클라이언트 주도 협상보다 빠르다.
3. 단
   * 투명 협상을 어떻게 하는지에 대한 정형화된 명세가 없다.
{% endtab %}
{% endtabs %}

## 클라이언트 주도 협상

서버에게 있어 가장 쉬운 방법이다. 이것은 물론 서버 입장에서 가장 구현하기 쉽고 최선의 사본이 선택될 것이다. 단점은 각 페이지에 두 번의 요청이 필요하다는 것이다. 한 번은 목록을 얻고 두 번째는 선택한 사본을 얻는다.

기술적으로, 서버에게는 클라이언트에게 줄 선택지를 표현하는 두 가지 방법이 있다. 여러 가지 버전에 대한 링크와 각각에 대한 설명이 담긴 HTML 페이지를 돌려주거나, 300 Multiple Choices 응답 코드로 HTTP/1.1 응답을 돌려주는 것이다.

## 서버 주도 협상

HTTP 서버가 클라이언트에게 보내줄 적절한 응답을 계산하기 위해 사용하는 메커니즘은 두 가지다.

* 내용 협상 헤더들을 살펴본다. 서버는 클라이언트의 Accept 관련 헤더들을 들여다보고 그에 알맞은 응답 헤더를 준비한다.
* 내용 협상 헤더 외의 다른 헤더들을 살펴본다. 예를 들어, 서버는 클라이언트의 User-Agent 헤더에 기반하여 응답을 보내줄 수도 있다.

| 헤더 | 설명 |
| :--- | :--- |
| Accept | 서버가 어떤  미디어 타입으로 보내도 되는지 알려준다. |
| Accept-Language | 서버가 어떤  언어으로 보내도 되는지 알려준다. |
| Accpet-Charset | 서버가 어떤  차셋으로 보내도 되는지 알려준다. |
| Accept-Encoding | 서버가 어떤  인코딩으로 보내도 되는지 알려준다. |

캐시는 반드시 캐시된 문서의 올바른 최선의 버전을 제공해주려 해야 하기 때문에 HTTP 프로토콜은 서버가 응답에 넣어 보낼 수 있는 Vary 헤더를 정의한다. Vary 헤더는 캐시에게 서버가 내줄 응답의 최선의 버전을 결정하기 위해 어떤 요청 헤더를 참고하고 있는지 말해준다.

## 투명 협상

투명 협상은 클라이언트 입장에서 협상하는 중개자 프락시를 둠으로써 클라이언트와의 메시지 교환을 최소화하는 동시에 서버 주도 협상으로 인한 부하를 서버에서 제거한다. 프락시는 클라이언트의 기대가 무엇인지 알고 있고, 클라이언트의 입장에서 협상을 수행할 수 있는 능력이 있는 것으로 가정된다. 

서버는 클라이언트의 요청에 가장 잘 맞는 것이 무엇인지 판별하려면 어떤 요청 헤더를 검새해야 하는지 프락시에게 반드시 말해줄 수 있어야 한다. 서버는 응답에 Vary 헤더를 포함시켜 보냄으로써 중개자에게 내용 협상을 위해 어떤 헤더를 사용하고 있는지 알려줄 수 있다.

## 트랜스코딩

서버가 클라이언트의 요구에 맞는 문서를 아예 갖고 있지 않다면, 서버는 기존의 문서를 클라이언트가 사용할 수 있는 무언가로 변환할 수도 있다. 이 옵션을 트랜스코딩이라고 부른다.

| 전 | 후 |
| :--- | :--- |
| HTML 문서 | [WML 문서](https://ko.wikipedia.org/wiki/무선_마크업_언어) |
| 고해상도 이미지 | 저해상도 이미지 |
| 64K색 이미지 | 흑백 이미지 |
| 프레임을 포함한 복잡한 페이지 | 프레임이나 이미지가 없는 단순한 텍스트 페이지 |
| 광고가 있는 페이지 | 광고가 없는 페이지 |

트랜스 코딩에는 포맷 변환, 정보 합성, 내용 주입의 세 종류가 있다.

### 포맷 변환

포맷 변환은 데이터를 클라이언트가 볼 수 있도록 한 포맷에서 다른 포맷으로 변환하는 것이다.

### 정보 합성

문서에서 정보의 요점을 추출하는 것을 정보 합성이라고 한다. 예로페이지에서 광고 및 로고 제거를 들 수 있다.

### 콘텐츠 주입

위의 두 종류의 트랜스코딩은 일반적으로 웹 문서의 양을 줄이지만, 오히려 양을 늘리는 또 다른 종류의 변환인 내용 주입 트랜스코딩이라는 것도 있다. 예로 자동 광고 생성과 사용자 추적 시스템이 있다.

