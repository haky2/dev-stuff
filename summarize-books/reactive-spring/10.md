# 10. 자! 드디어 릴리즈다

## 데브옵스 친화적인 앱의 중요성

모든 소프트웨어는 세 가지 관점에서 바라볼 수 있다.

* 시스템이 제공하는 비즈니스 기능에 관심이 있는 사용자
* 시스템을 개발 친화적으로 만들기를 원하는 개발팀
* 데브옵스 친화적인 시스템을 원하는 운영팀

데브옵스 팀 구성원의 관점에서 운영 환경 시스템을 지원/유지 보수하는 것이 어렵지 않은 경우에는 시스템이 데브옵스 친화적이라고 할 수 있다. 이는 시스템이 적절한 상태 점검 및 운영 지표를 제공하고 성능을 측정할 수 있는 방법을 가지고 있으며 서로 다른 컴포넌트를 유연하게 업데이트할 수 있다는 의미이다. 또한 MSA는 범용 소프트웨어 개발 기술이기 때문에 클라우드에 배포할 수 있도록 적절한 모니터링 기능을 갖춰야 한다.

IaaS, PaaS 및 쿠버네티스와 같은 컨테이너 관리 시스템은 OS 및 네트워크 구성, 파일 백업, 메트릭 수집과 관련된 많은 골칫거리를 제거했으며, 자동 확장을 비롯해 훨씬 더 많은 기능을 제공한다. 그러나 이러한 외부 서시븟 및 기술을 사용하면 비즈니스 응용 프로그램이 가지는 서비스 품질이 외부 요인에 의존해 조직 스스로 결정하지 못하게 된다. 이러한 책임은 여전히 개발자와 데브옵스 팀에게 있다.

소프트웨어를 운영을 효율적으로 하고 싶다면 다음 몇 가지 사항을 반드시 고려해야 한다

#### 서비스 식별

서비스 식별은 MSA의 필수 요소이다. 쿠버네티스와 같은 오케스트레이션 시스템이 여러 노드에 서비스 인스턴스를 생성하고 클라이언트 수요 증감에 따라 노드의 개수를 늘리거나 줄이기 때문에 반드시 필요하다. 실행 시점에 소스 코드의 서비스 이름, 종류, 버전, 빌드 시간 및 커밋 리비전을 식별할 수 있어야 한다. 그로 인해 운영 환경에서 올바르지 않거나 버그가 있는 서비스를 찾아낼 수 있어야 하고 다른 버전과의 성능 지표를 자동으로 추적/비교 할 수 있게 된다.

#### 서비스의 상태 확인

서비스 상태 검사는 오케스트레이션 시스템에서 실패한 서비스를 식별하고 해당 서비스를 다시 시작하는 데 사용된다. 전반적인 상태를 계산할 때는 필수 측정 항목만 포함시키는 것이 바람직하다. 일반적으로 상태를 체크하는 것은 해당 서비스가 요청을 받아들일 수 있는 수준이 되는지를 의미한다. 이 특성은 컨테이너의 관리 시스템에서 서비스 가용성을 확인하고 서비스를 재시작할지를 결정하는 데 사용된다.

#### 운영 메트릭 모니터링

훌륭한 시스템은 컴포넌트가 잘 동작할 뿐만 아니라 사용자가 예측 가능한 방식으로 작동한다. 시스템의 주요 메트릭에는 평균 응답 시간, 오류율 및 고부하 상황에서 요청을 처리하는 데 걸리는 시간 등이 있다. 높은 부하에서 시스템이 어떻게 작동하는지를 이해하면 시스템을 적절하게 확장할 수 있을 뿐만 아니라 인프라 비용에 대한 적절한 계획을 수립할 수 있다. 운영 메트릭은 추세 및 경향성을 제공하고 가동 시간에 따른 서비스 메모리 사용량과 같이 상호 연관 관계가 있는 특성에 대한 통찰력을 제공할 수 있다.

#### 로그를 살펴보고 로그 수준 동적 변경

비운영 특성을 모니터링하고 장애 상황을 점검할 때 로그를 활용한다. 요즘 모든 애플리케이션 로그는 하나의 위치에 저장하거나 하나의 시스템을 이용해 분석할 수 있어야 한다. 이를 위해 자바 생태계에서 ELK 스택\(엘라스틱 서치, 로그스태시, 키바나\)이 널리 사용된다. 일반적으로 INFO 레벨 이상의 로그를 저장하는 것으로 충분하고 DEBUG 또는 TRACE 레벨은 반복적인 이상이나 오류를 조사하는 경우에만 일시적으로 수집한다.

#### 사용자 요청 또는 데이터 흐름 추적

로그가 전체적인 내용을 표현할 정도로 충분하지 않다면 소프트웨어 내부의 프로세스를 추적할 수 있다. 프로세스를 추적하는 작업은 최근 서버 요청에 대한 자세한 로그를 살펴보는 일일 수도 있고, 대기 시간, DB 요청 및 각각의 소요 시간 등을 포함해 해당 요청의 전체적인 구조와 흐름을 따라가는 일일 수도 있다.

소프트웨어 시스템의 성공적인 운영을 위해서는 위에서 언급한 모든 기법이 필요하며, 다행히 스프링 생태계에서는 스프링 부트 액추에이터를 사용할 수 있다.

## 리액티브 스프링 애플리케이션 모니터링

### 스프링 부트 액추에이터

스프링 부트 액추에이터는 스프링 부트 애플리케이션 운영을 위한 기능을 제공하는 스프링 부트의 서브 프로젝트이다. 이 프로젝트에는 서비스 정보, 상태 확인, 메트릭 수집, 트래픽 추적, 데이터베이스 상태 확인 등이 포함된다. 스프링 부트 액추에이터의 핵심 아이디어는 애플리케이션 운영에 필요한 필수 메트릭을 제공하고 확장을 쉽게 할 수 있게 도와주는 것이다.

#### /info 엔드포인트

시간에 따라 시스템 모니터링, 확장 및 개선에 필요한 중요 정보를 제공한다. 애플리케이션 실행 파일에 대한 정보\(서비스 그룹, 서비스 ID, 서비스 이름 등\) 및 GIT 정보에 대한 정보를 제공한다.

#### /health 엔드포인트

서비스 상태를 확인하는 기능이다. 운영 관점에서 보면 정상적인 서비스라면 모든 하위 컴포넌트가 정상적이며 사용 가능한 상태여야 한다. 또한 상태 정보에는 장애의 잠재적 위험에 대응할 수 있도록 모든 세부 정보가 포함돼야 한다.

#### /metrics 엔드포인트

운영 메트릭을 제공하는 기능이다. 프로세스 가동 시간, 메모리 사용량, CPU 사용량 및 GC 일시 중지와 같은 JVM 특성을 모니터링한다. 또한 웹플럭스는 HTTP 요청 처리와 관련된 몇 가지 통계를 제공한다. 그러나 비즈니스 관점에서 서비스 내부 상황에 대해 의미 있는 통찰을 제공하려면 직접 운영 메트릭을 확장해야 한다.

#### /loggers 엔드포인트

로그 관리를 위한 두 개의 중요한 엔드포인트를 제공한다. 첫 번째는 /loggers로 애플리케이션을 다시 시작하지 않고도 런타임에 로깅 레벨을 확인하고 변경할 수 있는 것이고 두 번째는 /logfile로 원격 서버에 파일을 복사할 필요없이 애플리케이션 로그에 액세스할 수 있는 것이다.

### 스프링 클라우드 슬루스를 사용한 분산 추적

성공적인 리액티브 시스템 운영으 ㄹ위한 또 다른 중요한 요소는 서비스에서 이벤트가 어떻게 전달되는지, 요청이 어떻게 쌓이는지, 그리고 쌓인 요청을 해소하는 데 얼마나 오래 걸리는지를 이해하는 것이다. 서비스 간의 통신은 분산 시스템의 필수적인 부분이며, 문제가 발생했을 때 데이터 흐름에 대한 전체적인 이해 없이는 해결할 수 없다. 스프링 클라우드에는 sleuth라는 훌륭한 모듈이 있다. 슬루스는 스프링 부트 인프라와 완변하게 통합된 프로젝트로 분산형 추적이 가능하다.

### 미려한 UI를 지원하는 스프링 부트 어드민 2.x

스프링 부트 어드민 프로젝트는 스프링 부트 애플리케이션의 관리 및 모니터링을 할 수 있는 편리한 관리자 인터페이스를 제공하기 위해 시작됐다. 스프링 부트 어드민은 스프링 액추에이터 엔드포인트를 이용해 구축된 아름답고 사용자 친화적인 UI를 자랑한다. 이를 통해 애플리케이션 상태, CPU 및 메모리 메트릭, JVM 매개변수, 애플리케이션 클래스 패스, 애플리케이션 메트릭, HTTP 추적 및 감사 이벤트와 같은 모든 운영 정보를 볼 수 있다. 또한 활성 세션을 검사 및 삭제하고, 로그 레벨을 확인 및 변경할 수 있으며, 스레드 및 힙 덤프를 만드는 등의 작업을 수행할 수 있다.

