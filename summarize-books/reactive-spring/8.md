# 08. 클라우드 스트림으로 확장하기

## 메시지 브로커, 메시지 기반 시스템의 핵심

### 서버사이드 로드 밸런싱

분산 시스템 개발의 초기 단계에서 위치 투명성과 탄력성을 얻는 방법 중 하나는 HAProxy / Nginx와 같은 외부 로드 밸런서를 진입점으로 사용하거나 전체 시스템에 대한 중앙 로드 밸런서로 사용하는 것이다.

그러나 로드가 높을 때 로드 밸런서가 시스템의 핫스팟이 될 수 있다. 로드 밸런서가 병목 포인트가 되고 서비스 그룹의 최대 처리량이 로드 밸런서의 처리량을 넘을 수 없다. 로드 밸런서의 처리량을 높이기 위해 지불하는 비용이 높아질 수 밖에 없다. 또한 추가 백업 시스템에도 로드 밸런서를 설치해야 할 수 있다. 마지막으로 로드 밸런서를 관리하고 모니터링하기 위해 인프라 관리 비용이 추가로 발생 할 수 있다.

### 스프링 클라우드와 Ribbon을 이용한 클라이언트 사이드 로드 밸런싱

스프링 팀은 외부 로드 밸런서에 대한 해결책을 제공하는 대신, 넷플릭스의 분산 시스템 구축 사례를 따르기로 했다. 확장성 및 위치 투명성을 달성하는 방법 중 하나는 클라이언트측 로드 밸런싱을 사용하는 것이다.

클라이언트측 로드 밸런싱 개념은 간단하다. 즉, 각 서비스가 다른 서비스의 가용한 인스턴스를 확인하기 위해서 특정한 클라이언트와 통신을 시도한다. 이를 통해 서비스 간 로드 균형을 쉽게 맞출 수 있다. 

다른 서비스를 호출하는 클라이언트는 모든 요청을 로컬에서 로드 밸런싱해 대상 서비스의 인스턴스를 선택해야 한다. 이 기법을 사용하면 단일 장애 지점이 없으므로 확장성이 향상된다. 자바 및 스프링 생태계에서 인기 있는 라이브러리 중 하나는 Ribbon이다. Ribbon 라이브러리는 넷플릭스에서 만든 클라이언트측 로드 밸런서 패턴을 구현한 것이다.

#### 참고

* [\[Spring Cloud\] 클라이언트 사이드 로드 밸런싱 \(Client side Loadbalancing\) 이란??](http://blog.leekyoungil.com/?p=259)
* [넷플릭스로 알아보는 MSA](https://www.samsungsds.com/kr/insights/msa_and_netflix.html)
* [배민 API GATEWAY - spring cloud zuul 적용기](https://woowabros.github.io/r&d/2017/06/13/apigateway.html)

클라이언트측 로드 밸런싱은 시스템 상태의 정보를 업데이트하고 정확하게 유지하는 데 많은 노력이 필요하기 때문에 단일 실패 지점이 될 수 있다. 예를 들어 클러스터의 상태가 급속하게 변경된 상황이라면 등록된 정보는 현재 상황을 반영하지 못한 오래된 정보일 수도 있다.

### 탄력적이고 신뢰성 있는 메시지 전달 계층 역할의 메시지 브로커

메시지 브로커를 이용해 모든 요청을 메시지 큐를 통해 여유 있는 워커로 전송한다. 또한 메시지 큐는 워커 중 하나가 새 메시지를 요청할 때까지 메시지를 보관한다. 이러한 방식으로 메시지 큐는 시스템에 있는 워커의 수를 알 수 있고 그 정보를 기반으로 부하를 관리할 수 있다. 각 워커는 내부적으로 배압을 관리하고 각 워커의 현재 상태에 따라 메시지를 수신할 수 있다.

## 스프링 생태계와 연결해주는 스프링 클라우드 스트림

스프링 클라우드를 사용해 견고한 메시지 기반 시스템을 구축하는 강력한 방법 중 하나는 스프링 클라우드 스트림을 사용하는 것이다. 스프링 클라우드 스트림 모듈은 스프링 Integration 모듈과 스프링 메시지 모듈을 기반으로 구축되어 외부 서비스와 쉽게 연계할 수 있으며 비동기 메시지 서비스와도 쉽게 통합할 수 있다.

